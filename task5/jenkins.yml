---
- hosts: _lemp
  become: true
  vars:
    ssh_pub: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66316663353063623064626336343465363831643930343731316463373236316262646435353162
          3063623739366431356532343636383262353863663634640a323561636532626661626337653962
          32643731303333313931306432303231623333663163393134383762636438303337333363363362
          6332626662353531360a303534323737666431666336353364633735323935383137653662313030
          65633566353630626331623262326333623435383135386530653233363439323932666161353061
          63386564376535313935396336613164306532363137396662366163633962346262636437666266
          33383231356433343136323033363365396239316530633664626130666330646263656136346565
          64643563393533373665386539633965333663636164356361396130306330616234623539313933
          61643061663134636437333232333939656665623330336539326135356566393236616537316136
          61343333306364663532393766336464323061383439303361346666623663306136383539666337
          33633566313264353533333363336232313766386534653635376130383561663836353164353838
          34326639656633313664653361643037363164346236303363353936643934656537376230393339
          38353334303031333232643135333838313062356530343362643861623262303333326664323031
          39633165613465656635643336313537616535666662646233376131396238343262663239313564
          37643766303833626163363130396561383964346163646133653166666633313964636535643630
          66363331653535613133623032663865323530366632393834333438646335336530636463373835
          36396332366331383534353261633563376663303737396631333337646335376230353862346134
          38393164383438313863663237393061373033323935626133336562656238353733636239303231
          63396236633863653832343132396465643530383034356232636231613335396235346564366537
          33346531626366623336626535336434623230356564656131623137306634636633363737653836
          39366138316630353134613262623663363865376530663336613033323762353638623133313466
          37643332663861393662613366363363656263376562633864363064653931656663393232346537
          34666539383766356131366561303834653532666362343033326461373932653032306439376266
          61333364383234623435366537636230343063333664323164393931636433613462313762303635
          33326138326530393536636533373965613036646363326564396338383435393963393838366230
          34373338303263373265396461633961663139336462306331616364366239333933636530383736
          31346166346331643935313539323238333434343439373632623661336136393035636337633931
          35346336333737643234653566353465306330363332386330373063316235326661343366623136
          33623965613461326435306430346135303938363939646162356534623563623536313666653238
          34366335343264356434643230646234393765646137613338326261383933643561386266316463
          33346537343262656532623633373662333736663033386166353330313936393566343836336464
          39323335393861623264
  tasks:

    - name: Install prerequisites for Docker
      apt: name={{ item }} state=latest update-cache=yes
      loop: [ 'apt-transport-https', 'ca-certificates', 'curl', 'gnupg', 'lsb-release', 'python3-pip']

    - name: Add Docker GPG apt Key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker Repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Install Docker
      apt: name={{ item }} state=latest update-cache=yes
      loop: [ 'docker-ce', 'docker-ce-cli', 'containerd.io']

    - name: Install Docker SDK
      pip:
        name: docker

    - name: Create jenkins-agent container
      docker_container:
        name: jenkins_agent
        image: jenkins/ssh-agent:latest
        state: started
        published_ports:
          - 2222:22
        env:
            JENKINS_AGENT_SSH_PUBKEY: "{{ ssh_pub }}"
    
    - name: Setup Jenkins agent variables
      shell: VARS1="HOME=|USER=|MAIL=|LC_ALL=|LS_COLORS=|LANG=" && VARS2="HOSTNAME=|PWD=|TERM=|SHLVL=|LANGUAGE=|_=" && VARS="${VARS1}|${VARS2}" && docker exec jenkins_agent sh -c "env | egrep -v '^(${VARS})' >> /etc/environment"
      
    - name: Copy ssh key to hosts
      copy:
        src: /home/ubuntu/instance1.pem
        dest: /home/ubuntu/instance1.pem
        mode: 0644
        
    - name: Copy ssh key to Docker container
      command: docker cp /home/ubuntu/instance1.pem jenkins_agent:/home/jenkins